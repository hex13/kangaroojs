<!doctype html>

<meta charset="utf-8">
<script >
function assert(cond, desc) {
    desc = desc || '';
    if (!cond) {
        throw "ASSERTION ERROR (" + desc + ")";        
    }
    
}

</script>


<script src="http://underscorejs.org/underscore.js"></script>
<script src="http://code.jquery.com/jquery.js"></script>    
<script src="box2d/Box2dWeb-2.1a.3/Box2dWeb-2.1.a.3.min.js"></script>

<script src="model.js"></script>
<script src="messenger.js"></script>
<script src="container.js"></script>
<script src="timer.js"></script>

<script src="core.js"></script>
<script src="types.js"></script>
<script src="plugins.js"></script>

<script src="domview.js"></script>
<script src="simplephysics.js"></script>
<script src="box2dphysics.js"></script>

<body ondragstart="return false;">
<div id="templates">

    <div id="welcome">
        <div class="kang-dialog">

        <h3>Welcome</h3>

        <p>Good morning and welcome to the KangarooJS game microframework</p>

        </div>
    </div>

</div>

<link rel="stylesheet" type="text/css" href="kangaroo.css">

<script>


//18.06.2013
// 
// move movement (x+=vx, y+=vy) code from physics plugin to file simplephysics.js
// don't change model (don't send update message), but let physics module try 
// 1. move all objects (x = x + vx, y = y + vy
// 2. after movement - check for collisions
//      3. add collision flag to the model, eg.:
//                if (collision) 
//                     model().wasCollision = true;
// 4. loop on objects, 
//        if there was no collision: let nx = x, ny = y
//        else:  nx = nx, ny = ny (no change, no movement)
// 5. send update message
//
// pressupositions: nx, ny are not modified by plugins

// box2d version
// 1. update velocity of box2d object assigned with each of the kangaroo game objects
// 2. update box2d (step)
// 3. get position x, y from box2d objects, assign to nx, ny
// 4. send update message
// 4.5 - send move message? (to do some custom things after movement)
// 5. there's no need for collision detection nor move explicitly objects (nx = x + vx is not necessary)
//




//14.06.2013 
//!!TODO:
// handle various types of object (eg. graphicType = 'text', graphicType = 'image'
// draw them accordingly
// and make possibility of make "custom drawing objects" (eg. graphicType = 'custom' )
// so that when there is need to draw, they have their own method (or message handler) to do that
// eg. if (graphicType == 'custom') obj.render(context)
// or if (graphicType == 'custom') obj.send({type:'render', context:context}));

// make possibility of have children for parents 


// make also possibility of creating object with link to the previously existing model 
// so that many objects could use the same model (for example Hud Object could use Game Model for display Hud, in the same time, Game Model would be owned by the Game Object)

// let's make many sprites at once: kng.create('10x10 * sprite', { ....});
// or special function: kng.createMany({width:10, height:10, layout:'grid'}, 'sprite', { ....});
// or kng.createGroup({width:10, height:10, layout:'grid', name:'sprite'}, { ....});


//TODO: clean the code!!!
// move some functions to the main core of the framework!
// reconsider (and refactor) arguments passed to the Obj.send and to the event handlers


// do more tests:
// model
// messenger
// gameloop
// run in many web-browsers, check compability!

// sending. I don't know if we really need dependency injection for send function
// in event handlers
// maybe it should be called via kng namespace (ie. kng.send({to:obj, name:'kill'});


// do more features:
// image loader/preloader
// Finite State Machine, or some kind of Action Manager for objects
// Box2D, FabricJS integration
//

kng.init();


var env = {};
var com = new Messenger(function(id) {
    if (_.isString(id))
        return env[id];
    return id;
});
kng.send = function(msg) {
    com.send(msg);
}




var physics = new SimplePhysics;


var game = (function () {


    
    var view;
    var minimap;
    var timer;

    
    function initializeGame() {
        view = new DOMView($("#map")[0], 1);
        minimap = new DOMView($("#minimap")[0], .2);
        
        env.scene && env.scene.send({name:'cleanup'});
        env.hud && env.hud.send({name:'cleanup'});


        env.scene = kng.create('scene', { 
            model: {
                physics: new Box2DPhysics,
                pixelsPerUnit:1
            }
        });
        env.hud = kng.create('scene', { 
            model: {
                physics: new SimplePhysics
            }, plugins: [
                kng.ShapePlugin('circle')
            ]
        });    
        
        env.game = kng.create('', {
            model: {
                points:0
            },
            events: {
                points: function(model, plugin, aaa, msg) {
                    model().points += msg.points;
                }
            }
        });
        
    
        env.scene.send({name:'addObserver', observer:view});
        env.scene.send({name:'addObserver', observer:minimap});    
        
        env.hud.send({name:'addObserver', observer:view});      
    }
    
    
    
    function loadLevel() {

       
        var level = {
            objects:[{
                        name:'ball', 
                        model: {
                            x:450,y:200,vy:-1,vx:2,w:300,h:10,
                            gravity:0,
                            shape:'rect',
                            rotation:0
                        }
                },  {
                        name:'ball', 
                        model: {
                            x:260,y:100,vy:-1,vx:0.5,h:300,w:10,
                            gravity:0,
                            shape:'rect',
                            rotation:0
                        }
                } ]
        };
    
            
        com.send({to:'scene', name:'create', obj:level.objects});      
    }
    
  
    function gameloop() {
        
        com.send({to:'scene', name:'move'});
        com.send({to:'hud', name:'move'});

        com.dispatch();        
        view.render();
        minimap.render();
    }

    return {
        start: function () {
            timer && timer.stop();
            
            kng.define('ball', {
                events: {
                    init: function(model) {
                        //model().color = ['red','green','blue','#fa0','#aaa'][_.random(5)];
                    },
                    click: function(model, pluginData, $do, msg) {
                        $do.killYourself();
                    },
                    collision: function(model, pluginData, doFollowing, msg) {
                        doFollowing.
                            killYourself().
                            points(1).                
                            create('ball', {
                                x:_.random(0,700),
                                y:_.random(0,570),
                                vy:2,
                                vx:3
                            });
                    }, 
                    move: function(model) {

                    }
                }
            }, 'spr');           
        
        
        
            initializeGame();    
            loadLevel();
            timer = new kng.Timer(gameloop,17).start();
        },
        pause: function() {
            timer.stop();
        },
        resume: function() {
            timer.start();
        }
    };
    
})();

kng.loadImages({
        'ball':'images/1.png',
        'UnderscoreTemplate':'images/2.png',
}).run(game.start);

$(function() {
    $('#pause').on('click', function() {
        game.pause();
    });
    
    $('#start').on('click', function() {
        game.resume();
    });    
    
    $('#toggle').on('click', function() {
        alert('not implemented');
    });        
    
    $("#restart").on('click', function() {
        game.start();
    });

});





</script>

<button id="pause">Pause</button>
<button id="start">Start</button>
<button id="toggle">Toggle</button>
<button id="restart">Restart</button>
<div id="minimap" style="background:#020;position:fixed;height:300px;width:300px;right:0px"></div>

<div style="left:200px;top:200px;width:10px;height:2px;background:red;z-index:10;position:absolute;"></div>
<div id="map" style="width:900px;height:600px;background:#6a3"></div>
<canvas width=800 height=600 style="__display:none;margin-left:-3px;margin-top:14px;padding:0;background:#666;" id="canvas"></canvas>

<script src="debug.js"></script>


</body>
