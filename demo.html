<!doctype html>

<meta charset="utf-8">
<script >
function assert(cond, desc) {
    desc = desc || '';
    if (!cond) {
        throw "ASSERTION ERROR (" + desc + ")";        
    }
    
}

</script>


<script src="http://underscorejs.org/underscore.js"></script>
<script src="http://code.jquery.com/jquery.js"></script>    
<script src="model.js"></script>
<script src="messenger.js"></script>
<script src="container.js"></script>

<script src="core.js"></script>
<script src="types.js"></script>
<script src="plugins.js"></script>

<script src="domview.js"></script>
<script src="simplephysics.js"></script>


<link rel="stylesheet" type="text/css" href="kangaroo.css">

<script>

//14.06.2013 
//!!TODO:
// handle various types of object (eg. graphicType = 'text', graphicType = 'image'
// draw them accordingly
// and make possibility of make "custom drawing objects" (eg. graphicType = 'custom' )
// so that when there is need to draw, they have their own method (or message handler) to do that
// eg. if (graphicType == 'custom') obj.render(context)
// or if (graphicType == 'custom') obj.send({type:'render', context:context}));

// make possibility of have children for parents 


// make also possibility of creating object with link to the previously existing model 
// so that many objects could use the same model (for example Hud Object could use Game Model for display Hud, in the same time, Game Model would be owned by the Game Object)

// maybe change 'world' for the 'scene' and make some abstract scene object to further use
// in various contexts, maybe for example HUD would have its own scene, ang game entities would also have their own one.


// let's make many sprites at once: kng.create('10x10 * sprite', { ....});
// or special function: kng.createMany({width:10, height:10, layout:'grid'}, 'sprite', { ....});
// or kng.createGroup({width:10, height:10, layout:'grid', name:'sprite'}, { ....});


//TODO: clean the code!!!
// move some functions to the main core of the framework!
// reconsider (and refactor) arguments passed to the Obj.send and to the event handlers


// do more tests:
// model
// messenger
// gameloop
// run in many web-browsers, check compability!

// sending. I don't know if we really need dependency injection for send function
// in event handlers
// maybe it should be called via kng namespace (ie. kng.send({to:obj, name:'kill'});


// do more features:
// image loader/preloader
// Finite State Machine, or some kind of Action Manager for objects
// Box2D, FabricJS integration
//

kng.init();



var view = new DOMView;
var physics = new SimplePhysics;



kng.define('scene',{
        events: {
            init: function(model, plugin, aaa, msg) {
                this.observers = [];

                if (model().physics) {
                    this.physics = model().physics;//
                    this.send({name:'addObserver', observer:this.physics});                    
                }

            },
            
            addObserver: function(model, plugin, aaa, msg) {
                this.observers.push(msg.observer);
            },
            
            create: function(model, plugin, aaa, msg) {
                var obj = kng.create(msg.obj.name, msg.obj, this);
                this.observers.forEach(function(observer) {
                    observer.add(obj.model);
                });                
            },
            
            destroy: function(model, plugin, aaa, msg) {                
                var objModel = msg.obj.model;
                this.observers.forEach(function(observer) {
                    observer.remove(objModel);
                });

            },
            
            move: function() {
                this.physics && this.physics.update();
            }
        }        
});














$(function() {


    env.scene = kng.create('scene', { 
        model: {
            physics: new SimplePhysics
        }
    });
    env.scene2 = kng.create('scene', { 
        model: {
            physics: new SimplePhysics
        }
    });    
    
    env.game = kng.create('', {
        model: {
            points:0
        },
        events: {
            points: function(model, plugin, aaa, msg) {
                model().points += msg.points;
            }
        }
    });
    
       com.send({to:'scene', name:'create', obj: {name:'UnderscoreTemplate', 
            model: {
                state:'showPoints', 
                x:400, y:100, vx:0, vy:0, game:env.game.model(), template: '<%=game.points %>',
                text:'kotek', gravity:-0.0, collidable:false
            }, 
            options: {linkModel:false},
            events: {
                click: function(model) {
                    var state = model().state;                    
                    model(1).state = state=='showDate'?'showPoints':'showDate';
                }
            },
            states: {
                showPoints: {
                    move: function(model) {
                        model(1).template =  'punkty <%=game.points %>';
                    },
                    click: function() {
                        alert('kliknąłeś na punkty. teraz będzie data!');
                    }
                },
                showDate: {
                    move: function(model) {
                        model(1).template = new Date() + '';
                    },
                    click: function() {
                        alert('kliknąłeś na datę. teraz będą punkty!');
                    }
                    
                }
                
            }
       }});       
    
      env.scene.send({name:'addObserver', observer:view});
      env.scene2.send({name:'addObserver', observer:view});      

    function iterate() {

        
        com.send({to:'scene', name:'move'});
        com.send({to:'scene2', name:'move'});
        
        com.dispatch();
        view.render();
        document.title = env.game.model().points + ' punktów';
    }
    
    
    setInterval(iterate, 20);


    $(document).keydown(function(e) {
        if (e.keyCode!=13 && e.keyCode!=32) return;
        var scene = e.keyCode==13?'scene':'scene2';
        com.send({to:scene, name:'create', obj: {
                        name:'ball', model: {
                            x:0,y:600,vy:-10,vx:5
                        }
                    }
                });     
       com.send({to:'game', name:'points', points:1});   
       
       /*com.send({to:'world', name:'create', obj: {name:'UnderscoreTemplate', 
            model: {x:400, y:100, vx:0, vy:0, template: 'hej, tu kotek na <%=x %>, <%=y %>',
            text:'kotek', gravity:0.1}
       }});*/
       
       
    });
    
    $(document).keyup(function() {
    });
    
    
    $(document).on('mousemove', function(e) {
        var model = e.target && e.target.kngModel;
        if (model) {
            model(1).vx = model(1).vy = 0; 
        }

    });
    $(document).on('click', function(e) {
        var model = e.target && e.target.kngModel;
        if (model) {
            com.send({to:model.obj, name:'click'});
        }
        else {

            com.send({to:'scene', name:'create', e:e, obj: {
                name:'ball',
                model: {
                        targetx:e.pageX, targety:e.pageY
                    }
                }
            });
        }
    });     
    
});

var env = {};
var com = new Messenger(function(id) {
    if (_.isString(id))
        return env[id];
    return id;
});
kng.send = function(msg) {
    com.send(msg);
}





kng.define('ball', {
    events: {
        init: function(model) {
            model().color = ['red','green','blue','#fa0','#aaa'][_.random(5)];
        },
        collision: function(model, pluginData, doFollowing, msg) {
            doFollowing.
                killYourself().
                points(1).                
                create('ball', {
                    x:_.random(0,700),
                    y:_.random(0,570),
                    vy:2,
                    vx:3
                });
        }, 
        move: function(model) {
            if (model().y>600 || model().y<0)  {
                model(1).y -= model().vy*2;
                model(1).vy *= -0.8;                
            }
            if (model().x>600 || model().x<0)  {
                model(1).x -= model().vx*2;
                model(1).vx *= -0.8;                
            }
        }
    }
}, 'spr');



</script>
<script src="debug.js"></script>
